version: '3'

vars:
  # –í–µ—Ä—Å–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
  GO_VERSION: '1.24'
  GOLANGCI_LINT_VERSION: 'v1.62.2'
  GCI_VERSION: 'v0.13.6'
  GOFUMPT_VERSION: 'v0.8.0'
  BUF_VERSION: '1.53.0'
  PROTOC_GEN_GO_VERSION: 'v1.36.6'
  PROTOC_GEN_GO_GRPC_VERSION: 'v1.5.1'
  OGEN_VERSION: 'v1.12.0'
  YQ_VERSION: 'v4.45.2'
  GRPCURL_VERSION: 'v1.9.3'

  # –ü—É—Ç–∏ –∫ –±–∏–Ω–∞—Ä–Ω–∏–∫–∞–º
  BIN_DIR: '{{.ROOT_DIR}}/bin'
  GOLANGCI_LINT: '{{.BIN_DIR}}/golangci-lint'
  GCI: '{{.BIN_DIR}}/gci'
  GOFUMPT: '{{.BIN_DIR}}/gofumpt'
  BUF: '{{.BIN_DIR}}/buf'
  OGEN: '{{.BIN_DIR}}/ogen'
  YQ: '{{.BIN_DIR}}/yq'
  PROTOC_GEN_GO: '{{.BIN_DIR}}/protoc-gen-go'
  PROTOC_GEN_GO_GRPC: '{{.BIN_DIR}}/protoc-gen-go-grpc'
  GRPCURL: '{{.BIN_DIR}}/grpcurl'

  BUNDLE_OPENAPI: '{{.BIN_DIR}}/bundle-openapi'

  # OpenAPI –ø—É—Ç–∏
  OPEN_API_ORDER_V1_BASE: '{{.ROOT_DIR}}/shared/api/order/v1/order.openapi.yaml'
  OPEN_API_ORDER_V1_BUNDLE: '{{.ROOT_DIR}}/shared/api/bundles/order.openapi.v1.bundle.yaml'

  # –°–ø–∏—Å–æ–∫ –º–æ–¥—É–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞
  MODULES: inventory order payment shared

  # GitHub –ø—Ä–æ–µ–∫—Ç –¥–ª—è gci prefix
  PROJECT_PREFIX: 'github.com/Kosench/go-microservices-ecommerce'

tasks:
  # ==================== –£–°–¢–ê–ù–û–í–ö–ê –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í ====================

  install-formatters:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä—ã gci –∏ gofumpt –≤ ./bin"
    cmds:
      - |
        [ -f {{.GOFUMPT}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º gofumpt {{.GOFUMPT_VERSION}}...'
          GOBIN={{.BIN_DIR}} go install mvdan.cc/gofumpt@{{.GOFUMPT_VERSION}}
        }
      - |
        [ -f {{.GCI}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º gci {{.GCI_VERSION}}...'
          GOBIN={{.BIN_DIR}} go install github.com/daixiang0/gci@{{.GCI_VERSION}}
        }
    status:
      - test -x {{.GOFUMPT}}
      - test -x {{.GCI}}

  install-golangci-lint:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç golangci-lint –≤ –∫–∞—Ç–∞–ª–æ–≥ bin"
    cmds:
      - |
        [ -f {{.GOLANGCI_LINT}} ] || {
          mkdir -p {{.BIN_DIR}}
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º golangci-lint {{.GOLANGCI_LINT_VERSION}}..."
          GOBIN={{.BIN_DIR}} go install github.com/golangci/golangci-lint/cmd/golangci-lint@{{.GOLANGCI_LINT_VERSION}}
        }
    status:
      - test -x {{.GOLANGCI_LINT}}

  install-buf:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Buf –≤ –∫–∞—Ç–∞–ª–æ–≥ bin"
    cmds:
      - |
        [ -f {{.BUF}} ] || {
          mkdir -p {{.BIN_DIR}} tmp-buf
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º buf {{.BUF_VERSION}}..."
          curl -sSL \
            "https://github.com/bufbuild/buf/releases/download/v{{.BUF_VERSION}}/buf-$(uname -s)-$(uname -m).tar.gz" \
            | tar -xz -C tmp-buf
          mv tmp-buf/buf/bin/buf {{.BUF}}
          rm -rf tmp-buf
          chmod +x {{.BUF}}
        }
    status:
      - test -x {{.BUF}}

  install-proto-plugins:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç protoc –ø–ª–∞–≥–∏–Ω—ã –≤ –∫–∞—Ç–∞–ª–æ–≥ bin"
    cmds:
      - |
        [ -f {{.PROTOC_GEN_GO}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º protoc-gen-go {{.PROTOC_GEN_GO_VERSION}}...'
          GOBIN={{.BIN_DIR}} go install google.golang.org/protobuf/cmd/protoc-gen-go@{{.PROTOC_GEN_GO_VERSION}}
        }
      - |
        [ -f {{.PROTOC_GEN_GO_GRPC}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º protoc-gen-go-grpc {{.PROTOC_GEN_GO_GRPC_VERSION}}...'
          GOBIN={{.BIN_DIR}} go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@{{.PROTOC_GEN_GO_GRPC_VERSION}}
        }
    status:
      - test -x {{.PROTOC_GEN_GO}}
      - test -x {{.PROTOC_GEN_GO_GRPC}}

  install-tools:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏"
    deps:
      - install-formatters
      - install-golangci-lint
      - install-buf
      - install-proto-plugins
      - bundle-openapi:install
      - ogen:install
      - yq:install

  # ==================== –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï ====================

  format:
    desc: "–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç gofumpt + gci"
    deps: [ install-formatters ]
    cmds:
      - |
        echo "üßº –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ gofumpt..."
        for module in {{.MODULES}}; do
          if [ -d "$module" ]; then
            echo "  ‚Üí –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º $module"
            find $module -type f -name '*.go' ! -path '*/mocks/*' -exec {{.GOFUMPT}} -extra -w {} +
          fi
        done
      - |
        echo "üéØ –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏–º–ø–æ—Ä—Ç—ã —á–µ—Ä–µ–∑ gci..."
        for module in {{.MODULES}}; do
          if [ -d "$module" ]; then
            echo "  ‚Üí –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏–º–ø–æ—Ä—Ç—ã –≤ $module"
            find $module -type f -name '*.go' ! -path '*/mocks/*' -exec {{.GCI}} write -s standard -s default -s "prefix({{.PROJECT_PREFIX}})" {} +
          fi
        done

  # ==================== –õ–ò–ù–¢–ò–ù–ì ====================

  lint:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç golangci-lint –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π"
    deps: [ install-golangci-lint, format ]
    cmds:
      - |
        set -e
        ERR=0
        echo "üîç –õ–∏–Ω—Ç–∏–º –≤—Å–µ –º–æ–¥—É–ª–∏..."
        for mod in {{.MODULES}}; do
          if [ -d "$mod" ]; then
            echo "  ‚Üí –õ–∏–Ω—Ç–∏–º $mod"
            {{.GOLANGCI_LINT}} run $mod/... --config=.golangci.yml || ERR=1
          fi
        done
        exit $ERR

  # ==================== PROTO ====================

  proto:lint:
    desc: "–ü—Ä–æ–≤–µ—Ä–∫–∞ .proto —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∏–ª—é"
    deps: [ install-buf ]
    dir: shared/proto
    cmds:
      - '{{.BUF}} lint'

  proto:gen:
    desc: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ .proto —Ñ–∞–π–ª–æ–≤"
    deps: [ install-buf, install-proto-plugins, proto:lint ]
    dir: shared/proto
    cmds:
      - 'PATH={{.BIN_DIR}}:$$PATH {{.BUF}} generate'

  proto:clean:
    desc: "–£–¥–∞–ª—è–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ proto —Ñ–∞–π–ª—ã"
    cmds:
      - find shared -type f -name '*.pb.go' -delete
      - find shared -type f -name '*_grpc.pb.go' -delete

  # ==================== GO –ú–û–î–£–õ–ò ====================

  deps:download:
    desc: "–°–∫–∞—á–∏–≤–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π"
    cmds:
      - |
        for mod in {{.MODULES}}; do
          if [ -d "$mod" ]; then
            echo "üì¶ –°–∫–∞—á–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è $mod"
            (cd $mod && go mod download)
          fi
        done

  deps:tidy:
    desc: "–û—á–∏—â–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π"
    cmds:
      - |
        for mod in {{.MODULES}}; do
          if [ -d "$mod" ]; then
            echo "üßπ –û—á–∏—â–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è $mod"
            (cd $mod && go mod tidy)
          fi
        done

  # ==================== –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï ====================

  test:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π"
    cmds:
      - |
        set -e
        ERR=0
        echo "üß™ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã..."
        for mod in {{.MODULES}}; do
          if [ -d "$mod" ]; then
            echo "  ‚Üí –¢–µ—Å—Ç–∏—Ä—É–µ–º $mod"
            (cd $mod && go test -v -race -coverprofile=coverage.out ./...) || ERR=1
          fi
        done
        exit $ERR

  test:coverage:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç —Ç–µ—Å—Ç—ã —Å –æ—Ç—á–µ—Ç–æ–º –ø–æ–∫—Ä—ã—Ç–∏—è"
    cmds:
      - |
        for mod in {{.MODULES}}; do
          if [ -d "$mod" ]; then
            echo "üìä –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç –ø–æ–∫—Ä—ã—Ç–∏—è –¥–ª—è $mod"
            (cd $mod && go test -coverprofile=coverage.out ./... && go tool cover -html=coverage.out -o coverage.html)
          fi
        done

  # ==================== –û–ß–ò–°–¢–ö–ê ====================

  clean:
    desc: "–£–¥–∞–ª—è–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ –∫–µ—à–∏"
    cmds:
      - rm -rf {{.BIN_DIR}}
      - rm -rf tmp-buf
      - rm -rf shared/api/bundles
      - find . -name 'coverage.out' -delete
      - find . -name 'coverage.html' -delete
      - task: proto:clean

  # ==================== CI ====================

  ci:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–ª–Ω—ã–π CI pipeline"
    cmds:
      - task: install-tools
      - task: deps:download
      - task: deps:tidy
      - task: format
      - task: lint
      - task: proto:gen
      - task: test

  # ==================== –ü–û–ú–û–©–¨ ====================

  default:
    desc: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–¥–∞—á"
    cmds:
      - task --list

  ogen:install:
    desc: "–°–∫–∞—á–∏–≤–∞–µ—Ç ogen –≤ –ø–∞–ø–∫—É bin"
    cmds:
      - |
        [ -f {{.OGEN}} ] || {
          mkdir -p {{.BIN_DIR}}
          GOBIN={{.BIN_DIR}} go install github.com/ogen-go/ogen/cmd/ogen@{{.OGEN_VERSION}}
        }

  bundle-openapi:install:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç bundle-openapi –≤ bin/"
    cmds:
      - |
        [ -f {{.BUNDLE_OPENAPI}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º bundle-openapi...'
          cd shared/tools/bundle-openapi
          go build -o {{.ROOT_DIR}}/bin/bundle-openapi .
        }
    status:
      - test -x {{.BUNDLE_OPENAPI}}

  ogen:gen:
    desc: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ OpenAPI —Å–ø–µ–∫–∏"
    deps: [ ogen:install, yq:install, bundle-openapi:install ]
    cmds:
      # 1. Bundling OpenAPI
      - |
        echo "üì¶ Bundling OpenAPI specs..."
        mkdir -p shared/api/bundles
        {{.BUNDLE_OPENAPI}} \
          -input {{.OPEN_API_ORDER_V1_BASE}} \
          -output {{.OPEN_API_ORDER_V1_BUNDLE}}

      # 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞
      - |
        echo "üöÄ Generating from: {{.OPEN_API_ORDER_V1_BUNDLE}}"

        target=$({{.YQ}} e '."x-ogen".target' "{{.OPEN_API_ORDER_V1_BUNDLE}}")
        package=$({{.YQ}} e '."x-ogen".package' "{{.OPEN_API_ORDER_V1_BUNDLE}}")

        echo "üìÅ Target: $target"
        echo "üì¶ Package: $package"

        {{.OGEN}} \
          --target "$target" \
          --package "$package" \
          --clean \
          "{{.OPEN_API_ORDER_V1_BUNDLE}}" || exit 1

        echo "‚úÖ OpenAPI –∫–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"

  gen:
    desc: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—Å–µ—Ö proto –∏ OpenAPI –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–π"
    cmds:
      - task: proto:gen
      - task: ogen:gen

  deps:update:
    desc: "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ go.mod –≤–æ –≤—Å–µ—Ö –º–æ–¥—É–ª—è—Ö"
    cmds:
      - |
        echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ go.mod –≤–æ –≤—Å–µ—Ö –º–æ–¥—É–ª—è—Ö"
        for mod in {{.MODULES}}; do
          if [ -d "$mod" ]; then
            echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ $mod"
            (cd "$mod" && go mod tidy -compat=1.24) || exit 1
          fi
        done

  yq:install:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç yq –≤ bin/ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏"
    cmds:
      - |
        [ -f {{.YQ}} ] || {
          echo 'üì¶ Installing yq...'
          GOBIN={{.BIN_DIR}} go install github.com/mikefarah/yq/v4@{{.YQ_VERSION}}
        }

  grpcurl:install:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç grpcurl –≤ –∫–∞—Ç–∞–ª–æ–≥ bin"
    cmds:
      - |
        [ -f {{.GRPCURL}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º grpcurl {{.GRPCURL_VERSION}}...'
          GOBIN={{.BIN_DIR}} go install github.com/fullstorydev/grpcurl/cmd/grpcurl@{{.GRPCURL_VERSION}}
        }
    status:
      - test -x {{.GRPCURL}}

  test-api:
    desc: "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ API –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤"
    deps: [ grpcurl:install ]
    cmds:
      - |
        echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ —á–µ—Ä–µ–∑ gRPC –∏ REST"
        
        echo "üì¶ –¢–µ—Å—Ç 1: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–µ—Ç–∞–ª–µ–π –∏–∑ Inventory"
        PARTS_RESPONSE=$({{.GRPCURL}} -plaintext -d '{"filter":{}}' localhost:50051 inventory.v1.InventoryService/ListParts)
        
        if [[ -z "$PARTS_RESPONSE" || "$PARTS_RESPONSE" == *"error"* ]]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–µ—Ç–∞–ª–µ–π."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $PARTS_RESPONSE"
          exit 1
        fi
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º UUID –ø–µ—Ä–≤–æ–π –¥–µ—Ç–∞–ª–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —Ç–µ—Å—Ç–æ–≤
        PART_UUID=$(echo $PARTS_RESPONSE | grep -o '"uuid": "[^"]*' | head -1 | cut -d'"' -f4)
        if [ -z "$PART_UUID" ]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ UUID –¥–µ—Ç–∞–ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $PARTS_RESPONSE"
          exit 1
        fi
        echo "‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω —Å–ø–∏—Å–æ–∫ –¥–µ—Ç–∞–ª–µ–π, –ø–µ—Ä–≤–∞—è UUID: $PART_UUID"
        
        echo
        echo "üîç –¢–µ—Å—Ç 2: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–µ—Ç–∞–ª–∏ –ø–æ UUID"
        PART_RESPONSE=$({{.GRPCURL}} -plaintext -d "{\"uuid\":\"$PART_UUID\"}" localhost:50051 inventory.v1.InventoryService/GetPart)
        
        if [[ -z "$PART_RESPONSE" || "$PART_RESPONSE" == *"error"* ]]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–µ—Ç–∞–ª–∏."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $PART_RESPONSE"
          exit 1
        fi
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –¥–µ—Ç–∞–ª–∏ 
        PART_NAME=$(echo $PART_RESPONSE | grep -o '"name": "[^"]*' | cut -d'"' -f4)
        if [ -z "$PART_NAME" ]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∏–º—è –¥–µ—Ç–∞–ª–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $PART_RESPONSE"
          exit 1
        fi
        echo "‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω–∞ –¥–µ—Ç–∞–ª—å: $PART_NAME"
        
        echo
        echo "üë§ –¢–µ—Å—Ç 3: –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤"
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π UUID –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        USER_UUID=$(uuidgen | tr '[:upper:]' '[:lower:]')
        echo "‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: $USER_UUID"
        
        echo
        echo "üìù –¢–µ—Å—Ç 4: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (REST API)"
        ORDER_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/v1/orders" \
          -H "Content-Type: application/json" \
          -d "{\"user_uuid\":\"$USER_UUID\",\"part_uuids\":[\"$PART_UUID\"]}")
        
        if [[ -z "$ORDER_RESPONSE" || "$ORDER_RESPONSE" == *"error"* ]]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $ORDER_RESPONSE"
          exit 1
        fi
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º UUID –∑–∞–∫–∞–∑–∞ —Å —É—á–µ—Ç–æ–º —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ JSON
        ORDER_UUID=$(echo $ORDER_RESPONSE | grep -o '"uuid":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER_UUID" ]; then
          ORDER_UUID=$(echo $ORDER_RESPONSE | grep -o '"uuid": "[^"]*' | cut -d'"' -f4)
          if [ -z "$ORDER_UUID" ]; then
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å UUID –∑–∞–∫–∞–∑–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞."
            echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $ORDER_RESPONSE"
            exit 1
          fi
        fi
        echo "‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∑–∞–∫–∞–∑ —Å UUID: $ORDER_UUID"
        
        echo
        echo "üìä –¢–µ—Å—Ç 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å PENDING_PAYMENT)"
        ORDER_INFO_RESPONSE=$(curl -s -X GET "http://localhost:8080/api/v1/orders/$ORDER_UUID")
        
        if [[ -z "$ORDER_INFO_RESPONSE" || "$ORDER_INFO_RESPONSE" == *"error"* ]]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $ORDER_INFO_RESPONSE"
          exit 1
        fi
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ —Å —É—á–µ—Ç–æ–º —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ JSON
        ORDER_STATUS=$(echo $ORDER_INFO_RESPONSE | grep -o '"status":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER_STATUS" ]; then
          ORDER_STATUS=$(echo $ORDER_INFO_RESPONSE | grep -o '"status": "[^"]*' | cut -d'"' -f4)
          if [ -z "$ORDER_STATUS" ]; then
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞."
            echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $ORDER_INFO_RESPONSE"
            exit 1
          fi
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å PENDING_PAYMENT
        if [[ "$ORDER_STATUS" != *"PENDING_PAYMENT"* ]]; then
          echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞. –û–∂–∏–¥–∞–ª—Å—è PENDING_PAYMENT, –ø–æ–ª—É—á–µ–Ω: $ORDER_STATUS"
          exit 1
        fi
        echo "‚úÖ –ù–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π: $ORDER_STATUS"
        
        echo
        echo "üí∞ –¢–µ—Å—Ç 6: –û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ (REST API)"
        PAY_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/v1/orders/$ORDER_UUID/pay" \
          -H "Content-Type: application/json" \
          -d "{\"payment_method\":\"PAYMENT_METHOD_CARD\"}")
        
        if [[ "$PAY_RESPONSE" == *"error"* ]]; then
          echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞–∫–∞–∑–∞."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $PAY_RESPONSE"
          exit 1
        fi
        echo "‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ–ø–ª–∞—á–µ–Ω"
        
        echo
        echo "üìä –¢–µ—Å—Ç 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å PAID)"
        ORDER_INFO_RESPONSE=$(curl -s -X GET "http://localhost:8080/api/v1/orders/$ORDER_UUID")
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
        ORDER_STATUS=$(echo $ORDER_INFO_RESPONSE | grep -o '"status":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER_STATUS" ]; then
          ORDER_STATUS=$(echo $ORDER_INFO_RESPONSE | grep -o '"status": "[^"]*' | cut -d'"' -f4)
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç–∞—Ç—É—Å —Å—Ç–∞–ª PAID
        if [[ "$ORDER_STATUS" != *"PAID"* && "$ORDER_STATUS" != *"ASSEMBLED"* ]]; then
          echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã. –û–∂–∏–¥–∞–ª—Å—è PAID –∏–ª–∏ ASSEMBLED, –ø–æ–ª—É—á–µ–Ω: $ORDER_STATUS"
          exit 1
        fi
        echo "‚úÖ –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã: $ORDER_STATUS"
        
        echo
        echo "üìù –¢–µ—Å—Ç 8: –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–∫–∞–∑–∞ –¥–ª—è –æ—Ç–º–µ–Ω—ã (REST API)"
        ORDER2_RESPONSE=$(curl -s -X POST "http://localhost:8080/api/v1/orders" \
          -H "Content-Type: application/json" \
          -d "{\"user_uuid\":\"$USER_UUID\",\"part_uuids\":[\"$PART_UUID\"]}")
        
        if [[ -z "$ORDER2_RESPONSE" || "$ORDER2_RESPONSE" == *"error"* ]]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≤—Ç–æ—Ä–æ–π –∑–∞–∫–∞–∑."
          echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $ORDER2_RESPONSE"
          exit 1
        fi
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º UUID –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–∫–∞–∑–∞ —Å —É—á–µ—Ç–æ–º —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ JSON
        ORDER2_UUID=$(echo $ORDER2_RESPONSE | grep -o '"uuid":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER2_UUID" ]; then
          ORDER2_UUID=$(echo $ORDER2_RESPONSE | grep -o '"uuid": "[^"]*' | cut -d'"' -f4)
          if [ -z "$ORDER2_UUID" ]; then
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å UUID –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–∫–∞–∑–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞."
            echo "üîç –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $ORDER2_RESPONSE"
            exit 1
          fi
        fi
        echo "‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –≤—Ç–æ—Ä–æ–π –∑–∞–∫–∞–∑ —Å UUID: $ORDER2_UUID"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ–≥–æ –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
        ORDER2_INFO=$(curl -s -X GET "http://localhost:8080/api/v1/orders/$ORDER2_UUID")
        ORDER2_STATUS=$(echo $ORDER2_INFO | grep -o '"status":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER2_STATUS" ]; then
          ORDER2_STATUS=$(echo $ORDER2_INFO | grep -o '"status": "[^"]*' | cut -d'"' -f4)
        fi
        
        if [[ "$ORDER2_STATUS" != *"PENDING_PAYMENT"* ]]; then
          echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–∫–∞–∑–∞. –û–∂–∏–¥–∞–ª—Å—è PENDING_PAYMENT, –ø–æ–ª—É—á–µ–Ω: $ORDER2_STATUS"
          exit 1
        fi
        echo "‚úÖ –ù–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–∫–∞–∑–∞: $ORDER2_STATUS"
        
        echo
        echo "‚ùå –¢–µ—Å—Ç 9: –û—Ç–º–µ–Ω–∞ –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–∫–∞–∑–∞ (REST API)"
        echo "–û–∂–∏–¥–∞–µ–º 2 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–¥ –æ—Ç–º–µ–Ω–æ–π..."
        sleep 2
        
        curl -s -X POST "http://localhost:8080/api/v1/orders/$ORDER2_UUID/cancel"
        
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã..."
        
        ORDER2_INFO=$(curl -s -X GET "http://localhost:8080/api/v1/orders/$ORDER2_UUID")
        ORDER2_STATUS=$(echo $ORDER2_INFO | grep -o '"status":"[^"]*' | cut -d'"' -f4)
        if [ -z "$ORDER2_STATUS" ]; then
          ORDER2_STATUS=$(echo $ORDER2_INFO | grep -o '"status": "[^"]*' | cut -d'"' -f4)
        fi
        
        if [[ "$ORDER2_STATUS" != *"CANCELLED"* ]]; then
          echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Å—Ç–∞—Ç—É—Å –æ—Ç–º–µ–Ω–µ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞. –û–∂–∏–¥–∞–ª—Å—è CANCELLED, –ø–æ–ª—É—á–µ–Ω: $ORDER2_STATUS"
          echo "üîç –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞: $ORDER2_INFO"
          exit 1
        fi
        echo "‚úÖ –°—Ç–∞—Ç—É—Å –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–∫–∞–∑–∞ –ø–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã: $ORDER2_STATUS"
        
        echo
        echo "üéâ –í—Å–µ —Ç–µ—Å—Ç—ã API —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!"
